#!/bin/bash
#
# Homebridge Homematic meets Siri
# 

description="Installiert Homebridge zur Anbindung von Apple HomeKit an die CCU"

_module_install()
{
	progress "Zeroconf ..."
	apt-get -y --force-yes install libavahi-compat-libdnssd-dev 2>&1 > /dev/null
	mkdir -p $YAHM_TMP
	
#	progress "GCC ..."
#	apt-get -y --force-yes install make 2>&1 > /dev/null
	
#	progress "Setup GCC"
#	update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.9 60 --slave /usr/bin/g++ g++ /usr/bin/g++-4.9 >/dev/null
#   update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.6 40 --slave /usr/bin/g++ g++ /usr/bin/g++-4.7 >/dev/null

#	progress "Installing Node"
#   mkdir -p $YAHM_TMP
  
#	wget -q https://nodejs.org/dist/v4.0.0/node-v4.0.0-linux-armv7l.tar.gz -O $YAHM_TMP/nodejs.tar.gz
#	mkdir -p $YAHM_TMP/nodejs/
	
#	tar -xvf $YAHM_TMP/nodejs.tar.gz -C $YAHM_TMP/nodejs/ >/dev/null
#   cp -R $YAHM_TMP/nodejs/node-v4.0.0-linux-armv7l/* /usr/local/
	
#	progress "Cleaning ..."
#	rm $YAHM_TMP/nodejs.tar.gz
#	rm $YAHM_TMP/nodejs/ -R

    progress "Install NodeV6"
	curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash - >/dev/null
	apt-get install -y nodejs >/dev/null
	
	progress "Installing Homebridge"
    npm install -g homebridge --unsafe-perm >/dev/null
	progress "Installing Homematic Plugin"
    npm install -g homebridge-homematic --unsafe-perm >/dev/null
    
    mkdir /home/pi/.homebridge
    chown pi:pi /home/pi/.homebridge
    configfile="/home/pi/.homebridge/config.json"

    progress "Setup for Homematic"


	status=$(yahm-ctl -n ${LXCNAME} info)
 	state=$(echo "$status" | grep -oP "State:.*\b([A-Z]{1,})\b|\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b")
 	IFS=', ' read -r -a array <<< $state
 	INFO_IP=${array[2]}


    hazconfig="$(cat $configfile| grep 'bridge' | wc -l)"
    if [ "$hazconfig" = "0" ]; then

      CCUIP=$(whiptail --inputbox "Please enter your CCU IP" 20 60 "${INFO_IP}" 3>&1 1>&2 2>&3)

  subsection=$(whiptail --inputbox "Please choose a name for a subsection at your CCU. Insert all the devices, you want to control from HomeKit, in that subsection." 20 60 "HomeKit" 3>&1 1>&2 2>&3)
  
  
  if [ $? -eq 0 ]; then
   echo "{\"bridge\": {\"name\": \"Homebridge\", \"username\": \"CC:22:3D:E3:CE:30\",\"port\": 51826,\"pin\": \"031-45-154\"}," >> $configfile;
   echo "\"description\": \"This is an autogenerated config. only the homematic platform is enabled. see the sample for more\"," >> $configfile;
   echo "\"platforms\": [" >> $configfile;
   echo "{\"platform\": \"HomeMatic\",\"name\": \"HomeMatic CCU\",\"ccu_ip\": \"$CCUIP\"," >> $configfile;
   echo "\"subsection\":\"$subsection\",">>$configfile;
   echo "\"filter_device\":[],\"filter_channel\":[],\"outlets\":[]}"  >> $configfile;
   echo "],\"accessories\": []}"  >> $configfile;
  fi
fi
  chown pi:pi $configfile
whiptail --yesno "Would you like to start homebridge at boot by default?" $DEFAULT 20 60 2
RET=$?
if [ $RET -eq 0 ]; then

    wget -q https://raw.githubusercontent.com/thkl/homebridge/xmlrpc/homebridge_local -O $YAHM_TMP/homebridge
    mv $YAHM_TMP/homebridge /etc/init.d/homebridge
  	chmod 755 /etc/init.d/homebridge
    update-rc.d homebridge defaults
    service homebridge start
fi

}

_module_remove()
{
  	progress "Kill it with fire "
    service homebridge stop
  	progress "Remove Config"
  	rm -r /home/pi/.homebridge
	progress "Remove Homebridge"
	npm uninstall -g homebridge --unsafe-perm >/dev/null
	progress "Remove Homematic Plugin"
    npm uninstall -g homebridge-homematic --unsafe-perm >/dev/null
    progress "Remove Lauchndaemon"
    update-rc.d homebridge remove
    rm /etc/init.d/homebridge
}
